<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de Bord - Esp√®ce de Ganache</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    header h1 { font-size: 2.5em; margin-bottom: 10px; }
    .tabs { display: flex; background: #f0f0f0; border-bottom: 3px solid #667eea; }
    .tab {
      flex: 1; padding: 20px; text-align: center;
      cursor: pointer; background: #f8f9fa; border: none;
      font-size: 16px; font-weight: 600; color: #666; transition: all 0.3s;
    }
    .tab:hover { background: #e9ecef; }
    .tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; margin-bottom: -3px; }
    .content { padding: 30px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; }
    th { background: #f8f9fa; font-weight: 600; color: #495057; }
    tr:hover { background: #f8f9fa; }
    .badge { display:inline-block; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600; }
    .badge-success{background:#d4edda;color:#155724;}
    .badge-warning{background:#fff3cd;color:#856404;}
    .badge-danger{background:#f8d7da;color:#721c24;}
    .badge-info{background:#d1ecf1;color:#0c5460;}
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 20px; border-radius: 12px;
      text-align: center;
    }
    .stat-value { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
    #notification {
      position: fixed; top: 20px; right: 20px;
      background: #28a745; color: white;
      padding: 15px 25px; border-radius: 8px; display: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
  </style>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>üç´ Esp√®ce de Ganache</h1>
      <p>Tableau de Bord Gestion Produits & Stocks</p>
      <p id="dataLoadStatus" style="margin-top:10px;font-size:14px;"></p>
    </header>

    <div class="tabs">
      <button class="tab active" onclick="showTab('products', this)">üì¶ Produits</button>
      <button class="tab" onclick="showTab('packaging', this)">üìã Emballages</button>
      <button class="tab" onclick="showTab('materials', this)">üç´ Mati√®res Premi√®res</button>
    </div>

    <div class="content">
      <!-- Produits -->
      <div id="products" class="tab-content active">
        <h2>Produits Finis</h2>
        <div class="stats-grid" id="productStats"></div>
        <div class="table-container">
          <table id="productsTable">
            <thead>
              <tr>
                <th>Produit</th><th>Famille</th><th>Poids (g)</th>
                <th>Prix TTC</th><th>Prix/kg</th><th>Marge HT</th><th>Actif</th>
              </tr>
            </thead>
            <tbody id="productsTableBody"><tr><td colspan="7">Chargement...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Emballages -->
      <div id="packaging" class="tab-content">
        <h2>Emballages & Sacs</h2>
        <div class="stats-grid" id="packagingStats"></div>
        <h3>üì¶ Emballages</h3>
        <table><thead><tr><th>Emballage</th><th>Fournisseur</th><th>Prix HT</th><th>Prix TTC</th><th>Nb Produits</th></tr></thead>
          <tbody id="packagingTableBody"><tr><td colspan="5">Chargement...</td></tr></tbody></table>
        <h3 style="margin-top:30px;">üõçÔ∏è Sacs</h3>
        <table><thead><tr><th>Sac</th><th>Fournisseur</th><th>Prix HT</th><th>Prix TTC</th><th>TVA</th></tr></thead>
          <tbody id="sacsTableBody"><tr><td colspan="5">Chargement...</td></tr></tbody></table>
      </div>

      <!-- Mati√®res Premi√®res -->
      <div id="materials" class="tab-content">
        <h2>Mati√®res Premi√®res</h2>
        <div class="stats-grid" id="materialsStats"></div>
        <table>
          <thead><tr><th>Nom</th><th>Cat√©gorie</th><th>Fournisseur</th><th>Prix/unit√© TTC</th><th>Stock</th><th>Valeur Stock</th><th>Statut</th></tr></thead>
          <tbody id="materialsTableBody"><tr><td colspan="7">Chargement...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="notification"></div>

<script>
let data = { produits:[], emballages:[], sacs:[], matieres:[] };

function showTab(tabName, el) {
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  el.classList.add('active');
}

function toRows(tableData) {
  if (Array.isArray(tableData)) return tableData;
  if (tableData && tableData.id) {
    const n=tableData.id.length, out=[];
    const cols=Object.keys(tableData);
    for(let i=0;i<n;i++){const o={}; for(const c of cols) o[c]=tableData[c][i]; out.push(o);}
    return out;
  }
  return [];
}

async function loadAllData(){
  const status=document.getElementById('dataLoadStatus');
  status.textContent='‚è≥ Connexion √† Grist...';
  try {
    grist.ready({ requiredAccess:'full' });
    const [prod, emb, sacs, mp] = await Promise.all([
      grist.docApi.fetchTable('Produits_Finis'),
      grist.docApi.fetchTable('Emballages'),
      grist.docApi.fetchTable('SACS'),
      grist.docApi.fetchTable('2_MATIERES_PREMIERES')
    ]);
    data.produits=toRows(prod);
    data.emballages=toRows(emb);
    data.sacs=toRows(sacs);
    data.matieres=toRows(mp);

    updateTables();
    updateStats();
    status.textContent=`‚úÖ ${data.produits.length} produits, ${data.emballages.length} emballages, ${data.matieres.length} MP charg√©s`;
  } catch(e){
    console.error(e);
    status.textContent='‚ùå Erreur: '+e.message;
  }
}

function updateTables(){
  // Produits
  document.getElementById('productsTableBody').innerHTML =
    data.produits.map(p=>{
      const priceKg = p.Poids_Net_g ? (p.Prix_Vente_Unitaire_TTC/(p.Poids_Net_g/1000)) : 0;
      const marge = p.Marge_Unitaire_HT || 0;
      const mc = marge>3?'success':marge>1?'warning':'danger';
      const ac = p.Actif==='Oui'?'success':'warning';
      return `<tr>
        <td>${p.Nom_Produit||''}</td>
        <td><span class="badge badge-info">${p.Famille||''}</span></td>
        <td>${p.Poids_Net_g||''}</td>
        <td>${p.Prix_Vente_Unitaire_TTC? p.Prix_Vente_Unitaire_TTC.toFixed(2)+'‚Ç¨':''}</td>
        <td>${priceKg?priceKg.toFixed(2)+'‚Ç¨':''}</td>
        <td><span class="badge badge-${mc}">${marge.toFixed(2)}‚Ç¨</span></td>
        <td><span class="badge badge-${ac}">${p.Actif||'Non'}</span></td>
      </tr>`;
    }).join('') || '<tr><td colspan="7">Aucun produit</td></tr>';

  // Emballages
  document.getElementById('packagingTableBody').innerHTML =
    data.emballages.map(e=>{
      const nb = data.produits.filter(p=>p.Nom_Emballage_1===e.Nom_Emballage || p.Nom_Emballage_2===e.Nom_Emballage).length;
      return `<tr>
        <td>${e.Nom_Emballage||''}</td>
        <td>${e.Nom_Fournisseur||''}</td>
        <td>${e.Prix_Unitaire_HT?e.Prix_Unitaire_HT.toFixed(2)+'‚Ç¨':''}</td>
        <td>${e.Prix_Unitaire_TTC?e.Prix_Unitaire_TTC.toFixed(2)+'‚Ç¨':''}</td>
        <td><span class="badge badge-info">${nb}</span></td>
      </tr>`;
    }).join('') || '<tr><td colspan="5">Aucun emballage</td></tr>';

  // Sacs
  document.getElementById('sacsTableBody').innerHTML =
    data.sacs.map(s=>`
      <tr>
        <td>${s.Nom_Sac||''}</td>
        <td>${s.Nom_Fournisseur||''}</td>
        <td>${s.Prix_Unitaire_HT||0}‚Ç¨</td>
        <td>${s.Prix_Unitaire_TTC||0}‚Ç¨</td>
        <td>${s.TVA_Taux||'20'}%</td>
      </tr>`).join('') || '<tr><td colspan="5">Aucun sac</td></tr>';

  // Mati√®res premi√®res
  document.getElementById('materialsTableBody').innerHTML =
    data.matieres.map(m=>{
      const sc = m.Statut==='Actif'?'success':'warning';
      return `<tr>
        <td>${m.Nom_MP||''}</td>
        <td>${m.Categorie||''}</td>
        <td>${m.Fournisseur||''}</td>
        <td>${m.Prix_Achat_Unitaire_TTC?m.Prix_Achat_Unitaire_TTC.toFixed(2)+'‚Ç¨/'+m.Unite:''}</td>
        <td>${m.Stock_Actuel||0} ${m.Unite||''}</td>
        <td>${m.Valeur_Stock?m.Valeur_Stock.toFixed(2)+'‚Ç¨':''}</td>
        <td><span class="badge badge-${sc}">${m.Statut||''}</span></td>
      </tr>`;
    }).join('') || '<tr><td colspan="7">Aucune MP</td></tr>';
}

function updateStats(){
  // Produits
  const actifs=data.produits.filter(p=>p.Actif==='Oui').length;
  const prixMoyen=data.produits.length? data.produits.reduce((a,p)=>a+(p.Prix_Vente_Unitaire_TTC||0),0)/data.produits.length:0;
  document.getElementById('productStats').innerHTML=`
    <div class="stat-card"><div class="stat-value">${data.produits.length}</div><div>Total Produits</div></div>
    <div class="stat-card"><div class="stat-value">${actifs}</div><div>Produits Actifs</div></div>
    <div class="stat-card"><div class="stat-value">${prixMoyen.toFixed(2)}‚Ç¨</div><div>Prix Moyen TTC</div></div>`;
  // Emballages
  const fU=[...new Set(data.emballages.map(e=>e.Nom_Fournisseur))].length;
  document.getElementById('packagingStats').innerHTML=`
    <div class="stat-card"><div class="stat-value">${data.emballages.length}</div><div>Total Emballages</div></div>
    <div class="stat-card"><div class="stat-value">${data.sacs.length}</div><div>Types de Sacs</div></div>
    <div class="stat-card"><div class="stat-value">${fU}</div><div>Fournisseurs</div></div>`;
  // Mati√®res
  const valeurStock=data.matieres.reduce((a,m)=>a+(m.Valeur_Stock||0),0);
  const cat=[...new Set(data.matieres.map(m=>m.Categorie))].length;
  document.getElementById('materialsStats').innerHTML=`
    <div class="stat-card"><div class="stat-value">${data.matieres.length}</div><div>R√©f√©rences MP</div></div>
    <div class="stat-card"><div class="stat-value">${cat}</div><div>Cat√©gories</div></div>
    <div class="stat-card"><div class="stat-value">${(valeurStock/1000).toFixed(1)}k‚Ç¨</div><div>Valeur Stock</div></div>`;
}

window.onload=loadAllData;
</script>
</body>
</html>
